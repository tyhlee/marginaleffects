<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparisons to alternative software • marginaleffects</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Comparisons to alternative software">
<meta property="og:description" content="marginaleffects">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">marginaleffects</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx01_predictions.html" class="external-link">Adjusted predictions</a>
</li>
<li>
  <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx03_mfx.html" class="external-link">Marginal effects</a>
</li>
<li>
  <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx02_contrasts.html" class="external-link">Contrasts</a>
</li>
<li>
  <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx04_marginalmeans.html" class="external-link">Marginal means</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="alternative_software_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Comparisons to alternative software</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/HEAD/vignettes/alternative_software.Rmd" class="external-link"><code>vignettes/alternative_software.Rmd</code></a></small>
      <div class="hidden name"><code>alternative_software.Rmd</code></div>

    </div>

    
    
<p>If you do not like <code>marginaleffects</code>, you may want to consider one of the alternatives described below:</p>
<ul>
<li>
<code>margins</code>: <a href="https://cran.r-project.org/web/packages/margins/index.html" class="external-link uri">https://cran.r-project.org/web/packages/margins/index.html</a>
</li>
<li>
<code>prediction</code>: <a href="https://cran.r-project.org/web/packages/prediction/index.html" class="external-link uri">https://cran.r-project.org/web/packages/prediction/index.html</a>
</li>
<li>
<code>emmeans</code>: <a href="https://cran.r-project.org/web/packages/emmeans/index.html" class="external-link uri">https://cran.r-project.org/web/packages/emmeans/index.html</a>
</li>
<li>
<code>brmsmargins</code>: <a href="https://joshuawiley.com/brmsmargins/" class="external-link uri">https://joshuawiley.com/brmsmargins/</a>
</li>
<li>
<code>effects</code>: <a href="https://cran.r-project.org/web/packages/effects/index.html" class="external-link uri">https://cran.r-project.org/web/packages/effects/index.html</a>
</li>
<li>
<code>modelbased</code>: <a href="https://easystats.github.io/modelbased/" class="external-link uri">https://easystats.github.io/modelbased/</a>
</li>
<li>
<code>ggeffects</code>: <a href="https://strengejacke.github.io/ggeffects/" class="external-link uri">https://strengejacke.github.io/ggeffects/</a>
</li>
<li>
<code>Stata</code> by StataCorp LLC</li>
</ul>
<div class="section level2">
<h2 id="emmeans">
<code>emmeans</code><a class="anchor" aria-label="anchor" href="#emmeans"></a>
</h2>
<p>The <a href="https://cran.r-project.org/web/packages/emmeans/index.html" class="external-link"><code>emmeans</code> package</a> is developed by Russell V. Lenth and colleagues. It is an extremely powerful package which focuses on the computation of marginal means, but which can also compute slopes.</p>
<p>In my (Vincent’s) biased opinion, the main benefits of <code>marginaleffects</code> over <code>emmeans</code>:</p>
<ul>
<li>Support more model types.</li>
<li>Simpler and more intuitive user interface.</li>
<li>Easier to compute average marginal effects and unit-level marginal effects for whole datasets.</li>
<li>Easier to compute marginal effects (slopes) for custom grids and continuous regressors.</li>
<li>Common plots are easy with the <code><a href="../reference/plot_cap.html">plot_cap()</a></code> and <code><a href="../reference/plot_cme.html">plot_cme()</a></code> functions.</li>
</ul>
<p>Many of <code>marginaleffects</code> advantages come down to subjective preferences over user interface. Readers are thus encouraged to try both packages to see which interface they prefer. Please keep in mind that <code>emmeans</code> offers several features which are not yet available in <code>marginaleffects</code>, including:</p>
<ul>
<li>Equivalence tests.</li>
<li>Multiplicity adjustments.</li>
<li>Hypothesis tests on linear combinations of contrasts.</li>
<li>Some plots.</li>
</ul>
<p>The <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx04_marginalmeans.html" class="external-link">Marginal Means Vignette</a> includes side-by-side comparisons of <code>emmeans</code> and <code>marginaleffects</code> to compute marginal means. The rest of this section compares the syntax for contrasts and marginaleffects.</p>
<div class="section level3">
<h3 id="contrasts">Contrasts<a class="anchor" aria-label="anchor" href="#contrasts"></a>
</h3>
<p>AFAICT, <code>emmeans</code> does not provide an easy way to compute unit-level contrasts for every row of the dataset used to fit our model. Therefore, the side-by-side syntax shown below will always include <code>newdata=datagrid()</code> to specify that we want to compute only one contrast: at the mean values of the regressors. In day-to-day practice with <code><a href="../reference/marginaleffects.html">marginaleffects()</a></code>, however, this extra argument would not be necessary.</p>
<p>Fit a model:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvlenth/emmeans" class="external-link">emmeans</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">marginaleffects</a></span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></code></pre></div>
<p>Response scale, reference groups:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, specs <span class="op">=</span> <span class="st">"cyl"</span>, regrid <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span><span class="va">emm</span>, method <span class="op">=</span> <span class="st">"trt.vs.ctrl1"</span><span class="op">)</span>
<span class="co">#&gt;  contrast    estimate    SE  df z.ratio p.value</span>
<span class="co">#&gt;  cyl6 - cyl4   -0.222 0.394 Inf  -0.564  0.7842</span>
<span class="co">#&gt;  cyl8 - cyl4   -0.595 0.511 Inf  -1.163  0.4049</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; P value adjustment: dunnettx method for 2 tests</span>

<span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type term    contrast    comparison    std.error   statistic</span>
<span class="co">#&gt; 1     1 response   hp (x + 1) - x -1.557824e-10 6.803615e-07 -0.00022897</span>
<span class="co">#&gt; 2     1 response  cyl       6 - 4 -2.221851e-01 3.916435e-01 -0.56731461</span>
<span class="co">#&gt; 3     1 response  cyl       8 - 4 -5.946855e-01 5.097420e-01 -1.16664014</span>
<span class="co">#&gt;     p.value      conf.low    conf.high       hp cyl</span>
<span class="co">#&gt; 1 0.9998173 -1.333640e-06 1.333328e-06 146.6875   8</span>
<span class="co">#&gt; 2 0.5705005 -9.897921e-01 5.454220e-01 146.6875   8</span>
<span class="co">#&gt; 3 0.2433557 -1.593761e+00 4.043905e-01 146.6875   8</span></code></pre></div>
<p>Link scale, pairwise contrasts:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, specs <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span><span class="va">emm</span>, method <span class="op">=</span> <span class="st">"revpairwise"</span><span class="op">)</span>
<span class="co">#&gt;  contrast    estimate      SE  df z.ratio p.value</span>
<span class="co">#&gt;  cyl6 - cyl4   -0.905    1.63 Inf  -0.555  0.8439</span>
<span class="co">#&gt;  cyl8 - cyl4  -19.542 4367.17 Inf  -0.004  1.0000</span>
<span class="co">#&gt;  cyl8 - cyl6  -18.637 4367.16 Inf  -0.004  1.0000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Results are given on the log odds ratio (not the response) scale. </span>
<span class="co">#&gt; P value adjustment: tukey method for comparing a family of 3 estimates</span>

<span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>,
            type <span class="op">=</span> <span class="st">"link"</span>,
            newdata <span class="op">=</span> <span class="st">"mean"</span>,
            variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   rowid type term contrast  comparison   std.error    statistic   p.value</span>
<span class="co">#&gt; 1     1 link  cyl    6 - 4  -0.9048741    1.630231 -0.555058785 0.5788545</span>
<span class="co">#&gt; 2     1 link  cyl    8 - 4 -19.5417566 4367.165924 -0.004474700 0.9964297</span>
<span class="co">#&gt; 3     1 link  cyl    8 - 6 -18.6368825 4367.165407 -0.004267501 0.9965950</span>
<span class="co">#&gt;       conf.low  conf.high       hp cyl</span>
<span class="co">#&gt; 1    -4.100068    2.29032 146.6875   8</span>
<span class="co">#&gt; 2 -8579.029682 8539.94617 146.6875   8</span>
<span class="co">#&gt; 3 -8578.123795 8540.85003 146.6875   8</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="contrasts-by-group">Contrasts by group<a class="anchor" aria-label="anchor" href="#contrasts-by-group"></a>
</h3>
<p>Here is a slightly more complicated example with contrasts estimated by subgroup in a <code>glmmTMB</code> mixed effects model. First we estimate a model and compute pairwise contrasts by subgroup using <code>emmeans</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/glmmTMB/glmmTMB" class="external-link">glmmTMB</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvlenth/emmeans" class="external-link">emmeans</a></span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/lme4/VerbAgg.csv"</span><span class="op">)</span>
<span class="va">dat</span><span class="op">$</span><span class="va">woman</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Gender</span> <span class="op">==</span> <span class="st">"F"</span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html" class="external-link">glmmTMB</a></span><span class="op">(</span>
    <span class="va">woman</span> <span class="op">~</span> <span class="va">btype</span> <span class="op">*</span> <span class="va">resp</span> <span class="op">+</span> <span class="va">situ</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">Anger</span> <span class="op">|</span> <span class="va">item</span><span class="op">)</span>,
    family <span class="op">=</span> <span class="va">binomial</span>,
    data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, specs <span class="op">=</span> <span class="st">"btype"</span>, by <span class="op">=</span> <span class="st">"resp"</span><span class="op">)</span> |&gt;
    <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"revpairwise"</span>, adjust <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>
<span class="co">#&gt; resp = no:</span>
<span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span>
<span class="co">#&gt;  scold - curse  -0.0152 0.1097 7571  -0.139  0.8898</span>
<span class="co">#&gt;  shout - curse  -0.2533 0.1022 7571  -2.479  0.0132</span>
<span class="co">#&gt;  shout - scold  -0.2381 0.0886 7571  -2.686  0.0072</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; resp = perhaps:</span>
<span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span>
<span class="co">#&gt;  scold - curse  -0.2393 0.1178 7571  -2.031  0.0423</span>
<span class="co">#&gt;  shout - curse  -0.0834 0.1330 7571  -0.627  0.5309</span>
<span class="co">#&gt;  shout - scold   0.1559 0.1358 7571   1.148  0.2511</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; resp = yes:</span>
<span class="co">#&gt;  contrast      estimate     SE   df t.ratio p.value</span>
<span class="co">#&gt;  scold - curse   0.0391 0.1292 7571   0.302  0.7624</span>
<span class="co">#&gt;  shout - curse   0.5802 0.1784 7571   3.252  0.0012</span>
<span class="co">#&gt;  shout - scold   0.5411 0.1888 7571   2.866  0.0042</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Results are averaged over the levels of: situ </span>
<span class="co">#&gt; Results are given on the log odds ratio (not the response) scale.</span></code></pre></div>
<p>What did <code>emmeans</code> do to obtain these results? Roughly speaking:</p>
<ol style="list-style-type: decimal">
<li>Create a prediction grid with one cell for each combination of categorical predictors in the model, and all numeric variables held at their means.</li>
<li>Make adjusted predictions in each cell of the prediction grid.</li>
<li>Take the average of those predictions (marginal means) for each combination of <code>btype</code> (focal variable) and <code>resp</code> (group <code>by</code> variable).</li>
<li>Compute pairwise differences (contrasts) in marginal means across different levels of the focal variable <code>btype</code>.</li>
</ol>
<p>In short, <code>emmeans</code> computes pairwise contrasts between <em>marginal means</em>, which are themselves averages of adjusted predictions. This is different from the default types of contrasts produced by <code><a href="../reference/comparisons.html">comparisons()</a></code>, which reports contrasts between adjusted predictions, <em>without</em> averaging across a pre-specified grid of predictors. What does <code><a href="../reference/comparisons.html">comparisons()</a></code> do instead?</p>
<p>Let <code>newdata</code> be a data frame supplied by the user (or the original data frame used to fit the model), then:</p>
<ol style="list-style-type: decimal">
<li>Create a new data frame called <code>newdata2</code>, which is identical to <code>newdata</code> except that the focal variable is incremented by one level.</li>
<li>Compute contrasts as the difference between adjusted predictions made on the two datasets:
<ul>
<li><code>predict(model, newdata = newdata2) - predict(model, newdata = newdata)</code></li>
</ul>
</li>
</ol>
<p>Although it is not idiomatic, we can use still use <code><a href="../reference/comparisons.html">comparisons()</a></code> to emulate the <code>emmeans</code> results. First, we create a prediction grid with one cell for each combination of categorical predictor in the model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>
    model <span class="op">=</span> <span class="va">mod</span>,
    resp <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">resp</span>,
    situ <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">situ</span>,
    btype <span class="op">=</span> <span class="va">dat</span><span class="op">$</span><span class="va">btype</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">nd</span><span class="op">)</span>
<span class="co">#&gt; [1] 18</span></code></pre></div>
<p>This grid has 18 rows, one for each combination of levels for the <code>resp</code> (3), <code>situ</code> (2), and <code>btype</code> (3) variables (3 * 2 * 3 = 18).</p>
<p>Then we compute pairwise contrasts over this grid:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>,
    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"btype"</span> <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span>,
    newdata <span class="op">=</span> <span class="va">nd</span>,
    type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span>
<span class="co">#&gt; [1] 54</span></code></pre></div>
<p>There are 3 pairwise contrasts, corresponding to the 3 pairwise comparisons possible between the 3 levels of the focal variable <code>btype</code>: <code>scold-curse</code>, <code>shout-scold</code>, <code>shout-curse</code>. The <code><a href="../reference/comparisons.html">comparisons()</a></code> function estimates those 3 contrasts for each row of <code>newdata</code>, so we get <span class="math inline">\(18 \times 3 = 54\)</span> rows.</p>
<p>Finally, we wanted contrasts for each subgroup of the <code>resp</code> variable, so we average out the contrasts using <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> and the <code>by</code> argument:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cmp</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"resp"</span><span class="op">)</span>
<span class="co">#&gt; Average contrasts </span>
<span class="co">#&gt;      resp         btype   Effect Std. Error z value Pr(&gt;|z|)     2.5 %  97.5 %</span>
<span class="co">#&gt; 1      no scold - curse -0.07180    0.06882 -1.0434 0.296785 -0.206685 0.06308</span>
<span class="co">#&gt; 2 perhaps shout - curse  0.08117    0.08172  0.9933 0.320580 -0.079003 0.24135</span>
<span class="co">#&gt; 3     yes shout - scold  0.15298    0.08299  1.8432 0.065296 -0.009688 0.31564</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  glmmTMB </span>
<span class="co">#&gt; Prediction type:  link</span></code></pre></div>
<p>These results are identical to those produced by <code>emmeans</code> (except for <span class="math inline">\(t\)</span> vs. <span class="math inline">\(z\)</span>).</p>
</div>
<div class="section level3">
<h3 id="marginal-effects">Marginal Effects<a class="anchor" aria-label="anchor" href="#marginal-effects"></a>
</h3>
<p>AFAICT, <code><a href="https://rdrr.io/pkg/emmeans/man/emtrends.html" class="external-link">emmeans::emtrends</a></code> makes it easier to compute marginal effects for a few user-specified values than for large grids or for the full original dataset.</p>
<p>Response scale, user-specified values:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emtrends.html" class="external-link">emtrends</a></span><span class="op">(</span><span class="va">mod</span>, <span class="op">~</span><span class="va">hp</span>, <span class="st">"hp"</span>, regrid <span class="op">=</span> <span class="st">"response"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   hp hp.trend    SE  df asymp.LCL asymp.UCL</span>
<span class="co">#&gt;  147 -0.00786 0.011 Inf   -0.0294    0.0137</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Confidence level used: 0.95</span>

<span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type term contrast         dydx  std.error  statistic   p.value</span>
<span class="co">#&gt; 1     1 response   hp    dY/dX -0.007852329 0.01110851 -0.7068751 0.4796441</span>
<span class="co">#&gt; 2     1 response  cyl    6 - 4 -0.222185055 0.39164346 -0.5673146 0.5705005</span>
<span class="co">#&gt; 3     1 response  cyl    8 - 4 -0.594685481 0.50974200 -1.1666401 0.2433557</span>
<span class="co">#&gt;      conf.low  conf.high       hp cyl</span>
<span class="co">#&gt; 1 -0.02962461 0.01391995 146.6875   4</span>
<span class="co">#&gt; 2 -0.98979213 0.54542202 146.6875   4</span>
<span class="co">#&gt; 3 -1.59376144 0.40439048 146.6875   4</span></code></pre></div>
<p>Link scale, user-specified values:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emtrends.html" class="external-link">emtrends</a></span><span class="op">(</span><span class="va">mod</span>, <span class="op">~</span><span class="va">hp</span>, <span class="st">"hp"</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   hp hp.trend     SE  df asymp.LCL asymp.UCL</span>
<span class="co">#&gt;  147  -0.0326 0.0339 Inf    -0.099    0.0338</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Confidence level used: 0.95</span>

<span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, type <span class="op">=</span> <span class="st">"link"</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;   rowid type term contrast         dydx    std.error  statistic   p.value</span>
<span class="co">#&gt; 1     1 link   hp    dY/dX  -0.03257475 3.388105e-02 -0.9614446 0.3363287</span>
<span class="co">#&gt; 2     1 link  cyl    6 - 4  -0.90487411 1.630231e+00 -0.5550588 0.5788545</span>
<span class="co">#&gt; 3     1 link  cyl    8 - 4 -19.54175662 4.367166e+03 -0.0044747 0.9964297</span>
<span class="co">#&gt;        conf.low    conf.high       hp cyl</span>
<span class="co">#&gt; 1 -9.898038e-02 3.383088e-02 146.6875   4</span>
<span class="co">#&gt; 2 -4.100068e+00 2.290320e+00 146.6875   4</span>
<span class="co">#&gt; 3 -8.579030e+03 8.539946e+03 146.6875   4</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="margins-and-prediction">
<code>margins</code> and <code>prediction</code><a class="anchor" aria-label="anchor" href="#margins-and-prediction"></a>
</h2>
<p>The <a href="https://cran.r-project.org/web/packages/margins/index.html" class="external-link"><code>margins</code></a> and <a href="https://cran.r-project.org/web/packages/prediction/index.html" class="external-link"><code>prediction</code></a> packages for <code>R</code> were designed by Thomas Leeper to emulate the behavior of the <code>margins</code> command from <code>Stata</code>. These packages are trailblazers and strongly influenced the development of <code>marginaleffects</code>. The main benefits of <code>marginaleffects</code> over these packages are:</p>
<ul>
<li>Support more model types</li>
<li>Faster</li>
<li>Memory efficient</li>
<li>Plots using <code>ggplot2</code> instead of Base R</li>
<li>More extensive test suite</li>
<li>Active development</li>
</ul>
<p>The syntax of the two packages is very similar.</p>
<div class="section level3">
<h3 id="average-marginal-effects">Average Marginal Effects<a class="anchor" aria-label="anchor" href="#average-marginal-effects"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/leeper/margins" class="external-link">margins</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">marginaleffects</a></span><span class="op">)</span>

<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="va">mar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mar</span><span class="op">)</span>
<span class="co">#&gt;  factor     AME     SE       z      p   lower   upper</span>
<span class="co">#&gt;     cyl -0.9416 0.5509 -1.7092 0.0874 -2.0214  0.1382</span>
<span class="co">#&gt;      hp -0.0180 0.0119 -1.5188 0.1288 -0.0413  0.0052</span>
<span class="co">#&gt;      wt -3.1670 0.7406 -4.2764 0.0000 -4.6185 -1.7155</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term   Effect Std. Error z value   Pr(&gt;|z|)    2.5 %    97.5 %</span>
<span class="co">#&gt; 1  cyl -0.94162    0.55092  -1.709   0.087417 -2.02139  0.138159</span>
<span class="co">#&gt; 2   hp -0.01804    0.01188  -1.519   0.128803 -0.04132  0.005239</span>
<span class="co">#&gt; 3   wt -3.16697    0.74058  -4.276 1.8997e-05 -4.61848 -1.715471</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  lm </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="individual-level-marginal-effects">Individual-Level Marginal Effects<a class="anchor" aria-label="anchor" href="#individual-level-marginal-effects"></a>
</h3>
<p>Marginal effects in a user-specified data frame:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mar</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;    mpg cyl disp  hp drat    wt  qsec vs am gear carb   fitted se.fitted</span>
<span class="co">#&gt; 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 22.82043 0.6876212</span>
<span class="co">#&gt; 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 22.01285 0.6056817</span>
<span class="co">#&gt; 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 25.96040 0.7349593</span>
<span class="co">#&gt; 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.93608 0.5800910</span>
<span class="co">#&gt; 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 17.16780 0.8322986</span>
<span class="co">#&gt; 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 20.25036 0.6638322</span>
<span class="co">#&gt;     dydx_cyl    dydx_hp   dydx_wt Var_dydx_cyl  Var_dydx_hp Var_dydx_wt</span>
<span class="co">#&gt; 1 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt; 2 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt; 3 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt; 4 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt; 5 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt; 6 -0.9416168 -0.0180381 -3.166973    0.3035104 0.0001410451   0.5484521</span>
<span class="co">#&gt;   X_weights X_at_number</span>
<span class="co">#&gt; 1        NA           1</span>
<span class="co">#&gt; 2        NA           1</span>
<span class="co">#&gt; 3        NA           1</span>
<span class="co">#&gt; 4        NA           1</span>
<span class="co">#&gt; 5        NA           1</span>
<span class="co">#&gt; 6        NA           1</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type term       dydx std.error statistic    p.value  conf.low</span>
<span class="co">#&gt; 1     1 response  cyl -0.9416168 0.5509163 -1.709183 0.08741706 -2.021393</span>
<span class="co">#&gt; 2     2 response  cyl -0.9416168 0.5509163 -1.709183 0.08741706 -2.021393</span>
<span class="co">#&gt; 3     3 response  cyl -0.9416168 0.5509164 -1.709183 0.08741712 -2.021393</span>
<span class="co">#&gt; 4     4 response  cyl -0.9416168 0.5509163 -1.709183 0.08741706 -2.021393</span>
<span class="co">#&gt; 5     5 response  cyl -0.9416168 0.5509164 -1.709183 0.08741710 -2.021393</span>
<span class="co">#&gt; 6     6 response  cyl -0.9416168 0.5509163 -1.709183 0.08741706 -2.021393</span>
<span class="co">#&gt;   conf.high  mpg cyl  hp    wt</span>
<span class="co">#&gt; 1 0.1381594 21.0   6 110 2.620</span>
<span class="co">#&gt; 2 0.1381594 21.0   6 110 2.875</span>
<span class="co">#&gt; 3 0.1381595 22.8   4  93 2.320</span>
<span class="co">#&gt; 4 0.1381594 21.4   6 110 3.215</span>
<span class="co">#&gt; 5 0.1381595 18.7   8 175 3.440</span>
<span class="co">#&gt; 6 0.1381594 18.1   6 105 3.460</span>
<span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fl">4</span>, hp <span class="op">=</span> <span class="fl">110</span>, wt <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="marginal-effects-at-the-mean">Marginal Effects at the Mean<a class="anchor" aria-label="anchor" href="#marginal-effects-at-the-mean"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="../reference/mean_or_mode.html">mean_or_mode</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>, unit_ses <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mar</span><span class="op">)</span>
<span class="co">#&gt;        mpg    cyl     disp       hp     drat      wt     qsec     vs      am</span>
<span class="co">#&gt; 1 20.09062 6.1875 230.7219 146.6875 3.596563 3.21725 17.84875 0.4375 0.40625</span>
<span class="co">#&gt;     gear   carb   fitted se.fitted   dydx_cyl    dydx_hp   dydx_wt Var_dydx_cyl</span>
<span class="co">#&gt; 1 3.6875 2.8125 20.09062 0.4439832 -0.9416168 -0.0180381 -3.166973    0.3035013</span>
<span class="co">#&gt;    Var_dydx_hp Var_dydx_wt SE_dydx_cyl SE_dydx_hp SE_dydx_wt X_weights</span>
<span class="co">#&gt; 1 0.0001410453     0.54846   0.5509096 0.01187625  0.7405808        NA</span>
<span class="co">#&gt;   X_at_number</span>
<span class="co">#&gt; 1           1</span>

<span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type term       dydx  std.error statistic      p.value    conf.low</span>
<span class="co">#&gt; 1     1 response  cyl -0.9416168 0.55091633 -1.709183 8.741706e-02 -2.02139298</span>
<span class="co">#&gt; 2     1 response   hp -0.0180381 0.01187625 -1.518838 1.288032e-01 -0.04131512</span>
<span class="co">#&gt; 3     1 response   wt -3.1669731 0.74057579 -4.276366 1.899688e-05 -4.61847499</span>
<span class="co">#&gt;     conf.high    cyl       hp      wt</span>
<span class="co">#&gt; 1  0.13815935 6.1875 146.6875 3.21725</span>
<span class="co">#&gt; 2  0.00523892 6.1875 146.6875 3.21725</span>
<span class="co">#&gt; 3 -1.71547124 6.1875 146.6875 3.21725</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="counterfactual-average-marginal-effects">Counterfactual Average Marginal Effects<a class="anchor" aria-label="anchor" href="#counterfactual-average-marginal-effects"></a>
</h3>
<p>The <code>at</code> argument of the <code>margins</code> package emulates <code>Stata</code> by fixing the values of some variables at user-specified values, and by replicating the full dataset several times for each combination of the supplied values (see the <code>Stata</code> section below). For example, if the dataset includes 32 rows and the user calls <code>at=list(cyl=c(4, 6))</code>, <code>margins</code> will compute 64 unit-level marginal effects estimates:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mtcars</span>
<span class="va">dat</span><span class="op">$</span><span class="va">cyl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">*</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="va">mar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mar</span><span class="op">)</span>
<span class="co">#&gt;  factor    cyl     AME     SE       z      p   lower   upper</span>
<span class="co">#&gt;     cyl 4.0000  0.0381 0.6000  0.0636 0.9493 -1.1378  1.2141</span>
<span class="co">#&gt;     cyl 6.0000  0.0381 0.5999  0.0636 0.9493 -1.1376  1.2139</span>
<span class="co">#&gt;     cyl 8.0000  0.0381 0.5999  0.0636 0.9493 -1.1376  1.2139</span>
<span class="co">#&gt;      hp 4.0000 -0.0878 0.0267 -3.2937 0.0010 -0.1400 -0.0355</span>
<span class="co">#&gt;      hp 6.0000 -0.0499 0.0154 -3.2397 0.0012 -0.0800 -0.0197</span>
<span class="co">#&gt;      hp 8.0000 -0.0120 0.0108 -1.1065 0.2685 -0.0332  0.0092</span>
<span class="co">#&gt;      wt 4.0000 -3.1198 0.6613 -4.7175 0.0000 -4.4160 -1.8236</span>
<span class="co">#&gt;      wt 6.0000 -3.1198 0.6613 -4.7175 0.0000 -4.4160 -1.8236</span>
<span class="co">#&gt;      wt 8.0000 -3.1198 0.6613 -4.7175 0.0000 -4.4160 -1.8236</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>, grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span>, by <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term cyl   Effect Std. Error  z value   Pr(&gt;|z|)    2.5 %    97.5 %</span>
<span class="co">#&gt; 1  cyl   4  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span>
<span class="co">#&gt; 2  cyl   6  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span>
<span class="co">#&gt; 3  cyl   8  0.03814    0.59989  0.06357 0.94930949 -1.13762  1.213899</span>
<span class="co">#&gt; 4   hp   4 -0.08778    0.02665 -3.29366 0.00098892 -0.14002 -0.035545</span>
<span class="co">#&gt; 5   hp   6 -0.04987    0.01539 -3.23974 0.00119639 -0.08004 -0.019701</span>
<span class="co">#&gt; 6   hp   8 -0.01197    0.01081 -1.10649 0.26851517 -0.03316  0.009229</span>
<span class="co">#&gt; 7   wt   4 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span>
<span class="co">#&gt; 8   wt   6 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span>
<span class="co">#&gt; 9   wt   8 -3.11981    0.66132 -4.71754 2.3871e-06 -4.41598 -1.823648</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  lm </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adjusted-predictions">Adjusted Predictions<a class="anchor" aria-label="anchor" href="#adjusted-predictions"></a>
</h3>
<p>The syntax to compute adjusted predictions using the <code>predictions</code> package or <code>marginaleffects</code> is very similar:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">prediction</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/prediction/man/prediction.html" class="external-link">prediction</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;    mpg cyl disp  hp drat    wt  qsec vs am gear carb   fitted se.fitted</span>
<span class="co">#&gt; 1 21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 21.90488 0.6927034</span>
<span class="co">#&gt; 2 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 21.10933 0.6266557</span>
<span class="co">#&gt; 3 22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 25.64753 0.6652076</span>
<span class="co">#&gt; 4 21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 20.04859 0.6041400</span>
<span class="co">#&gt; 5 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 17.25445 0.7436172</span>
<span class="co">#&gt; 6 18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 19.53360 0.6436862</span>

<span class="fu">marginaleffects</span><span class="fu">::</span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> |&gt; <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt;   rowid     type predicted std.error statistic       p.value conf.low conf.high</span>
<span class="co">#&gt; 1     1 response  21.90488 0.6927034  31.62231 1.822647e-219 20.54721  23.26256</span>
<span class="co">#&gt; 2     2 response  21.10933 0.6266557  33.68569 9.366966e-249 19.88111  22.33755</span>
<span class="co">#&gt; 3     3 response  25.64753 0.6652076  38.55568  0.000000e+00 24.34375  26.95131</span>
<span class="co">#&gt; 4     4 response  20.04859 0.6041400  33.18534 1.751939e-241 18.86450  21.23268</span>
<span class="co">#&gt; 5     5 response  17.25445 0.7436172  23.20340 4.207206e-119 15.79698  18.71191</span>
<span class="co">#&gt; 6     6 response  19.53360 0.6436862  30.34646 2.797513e-202 18.27200  20.79520</span>
<span class="co">#&gt;    mpg cyl  hp    wt</span>
<span class="co">#&gt; 1 21.0   6 110 2.620</span>
<span class="co">#&gt; 2 21.0   6 110 2.875</span>
<span class="co">#&gt; 3 22.8   4  93 2.320</span>
<span class="co">#&gt; 4 21.4   6 110 3.215</span>
<span class="co">#&gt; 5 18.7   8 175 3.440</span>
<span class="co">#&gt; 6 18.1   6 105 3.460</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="stata">
<code>Stata</code><a class="anchor" aria-label="anchor" href="#stata"></a>
</h2>
<p><code>Stata</code> is a good but expensive software package for statistical analysis. It is published by StataCorp LLC. This section compares <code>Stata</code>’s <code>margins</code> command to <code>marginaleffects</code>.</p>
<p>The results produced by <code>marginaleffects</code> are extensively tested against <code>Stata</code>. See the <a href="https://github.com/vincentarelbundock/marginaleffects/tree/main/tests/testthat/stata" class="external-link">test suite</a> for a list of the dozens of models where we compared estimates and standard errors.</p>
<div class="section level3">
<h3 id="average-marginal-effect-ames">Average Marginal Effect (AMEs)<a class="anchor" aria-label="anchor" href="#average-marginal-effect-ames"></a>
</h3>
<p>Marginal effects are unit-level quantities. To compute “average marginal effects”, we first calculate marginal effects for each observation in a dataset. Then, we take the mean of those unit-level marginal effects.</p>
<div class="section level4">
<h4 id="stata-1">Stata<a class="anchor" aria-label="anchor" href="#stata-1"></a>
</h4>
<p>Both Stata’s <code>margins</code> command and the <code>marginaleffects</code> function can calculate average marginal effects (AMEs). Here is an example showing how to estimate AMEs in Stata:</p>
<pre><code>quietly reg mpg cyl hp wt
margins, dydx(*)

Average marginal effects                        Number of obs     =         32
Model VCE    : OLS
 
Expression   : Linear prediction, predict()
dy/dx w.r.t. : cyl hp wt
 
------------------------------------------------------------------------------
    |            Delta-method
    |      dy/dx   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
------------------------------------------------------------------------------
cyl |  -.9416168   .5509164    -1.71   0.098    -2.070118    .1868842
 hp |  -.0180381   .0118762    -1.52   0.140    -.0423655    .0062893
 wt |  -3.166973   .7405759    -4.28   0.000    -4.683974   -1.649972
------------------------------------------------------------------------------</code></pre>
</div>
<div class="section level4">
<h4 id="marginaleffects">marginaleffects<a class="anchor" aria-label="anchor" href="#marginaleffects"></a>
</h4>
<p>The same results can be obtained with <code><a href="../reference/marginaleffects.html">marginaleffects()</a></code> and <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> like this:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">"marginaleffects"</a></span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">cyl</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>
<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term   Effect Std. Error z value   Pr(&gt;|z|)    2.5 %    97.5 %</span>
<span class="co">#&gt; 1  cyl -0.94162    0.55092  -1.709   0.087417 -2.02139  0.138159</span>
<span class="co">#&gt; 2   hp -0.01804    0.01188  -1.519   0.128803 -0.04132  0.005239</span>
<span class="co">#&gt; 3   wt -3.16697    0.74058  -4.276 1.8997e-05 -4.61848 -1.715471</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  lm </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
<p>Note that <code>Stata</code> reports t statistics while <code>marginaleffects</code> reports Z. This produces slightly different p-values because this model has low degrees of freedom: <code>mtcars</code> only has 32 rows</p>
</div>
</div>
<div class="section level3">
<h3 id="counterfactual-marginal-effects">Counterfactual Marginal Effects<a class="anchor" aria-label="anchor" href="#counterfactual-marginal-effects"></a>
</h3>
<p>A “counterfactual marginal effect” is a special quantity obtained by replicating a dataset while fixing some regressor to user-defined values.</p>
<p>Concretely, Stata computes counterfactual marginal effects in 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Duplicate the whole dataset 3 times and sets the values of <code>cyl</code> to the three specified values in each of those subsets.</li>
<li>Calculate marginal effects for each observation in that large grid.</li>
<li>Take the average of marginal effects for each value of the variable of interest.</li>
</ol>
<div class="section level4">
<h4 id="stata-2">Stata<a class="anchor" aria-label="anchor" href="#stata-2"></a>
</h4>
<p>With the <code>at</code> argument, Stata’s <code>margins</code> command estimates average <em>counterfactual</em> marginal effects. Here is an example:</p>
<pre><code>quietly reg mpg i.cyl##c.hp wt
margins, dydx(hp) at(cyl = (4 6 8))

Average marginal effects                        Number of obs     =         32
Model VCE    : OLS

Expression   : Linear prediction, predict()
dy/dx w.r.t. : hp

1._at        : cyl             =           4

2._at        : cyl             =           6

3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
hp           |
         _at |
          1  |   -.099466   .0348665    -2.85   0.009    -.1712749   -.0276571
          2  |  -.0213768    .038822    -0.55   0.587    -.1013323    .0585787
          3  |   -.013441   .0125138    -1.07   0.293    -.0392137    .0123317
------------------------------------------------------------------------------</code></pre>
<!-- Adapted from this GitHub issue: https://github.com/strengejacke/ggeffects/issues/249 -->
</div>
<div class="section level4">
<h4 id="marginaleffects-1">marginaleffects<a class="anchor" aria-label="anchor" href="#marginaleffects-1"></a>
</h4>
<p>You can estimate average counterfactual marginal effects with <code><a href="../reference/marginaleffects.html">marginaleffects()</a></code> by, first, setting the <code>grid_type</code> argument of <code><a href="../reference/datagrid.html">datagrid()</a></code> to <code>"counterfactual"</code> and, second, by telling the <code>summary</code> function that you want to average within groups:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">*</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span>
    <span class="va">mod</span>,
    variables <span class="op">=</span> <span class="st">"hp"</span>,
    newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>,
                       grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span>, by <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term cyl   Effect Std. Error z value Pr(&gt;|z|)    2.5 %   97.5 %</span>
<span class="co">#&gt; 1   hp   4 -0.09947    0.03487 -2.8528 0.004334 -0.16780 -0.03113</span>
<span class="co">#&gt; 2   hp   6 -0.02138    0.03882 -0.5506 0.581884 -0.09747  0.05471</span>
<span class="co">#&gt; 3   hp   8 -0.01344    0.01251 -1.0741 0.282780 -0.03797  0.01109</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  lm </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
<p>This is equivalent to taking the group-wise mean of observation-level marginal effects:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">dydx</span> <span class="op">~</span> <span class="va">term</span> <span class="op">+</span> <span class="va">cyl</span>, data <span class="op">=</span> <span class="va">mfx</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>
<span class="co">#&gt;   term cyl        dydx</span>
<span class="co">#&gt; 1   hp   4 -0.09946598</span>
<span class="co">#&gt; 2   hp   6 -0.02137679</span>
<span class="co">#&gt; 3   hp   8 -0.01344103</span></code></pre></div>
<!-- Taken from https://github.com/vincentarelbundock/marginaleffects/issues/226 -->
<p>Note that following <code>Stata</code>, the standard errors for group-averaged marginal effects are computed by taking the “Jacobian at the mean:”</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mfx</span>, <span class="st">"jacobian"</span><span class="op">)</span>
<span class="va">J_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">J</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span>
<span class="va">J_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">J_mean</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">J_mean</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">J_mean</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">J_mean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.03486650 0.03882203 0.01251382</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="average-counterfactual-adjusted-predictions">Average Counterfactual Adjusted Predictions<a class="anchor" aria-label="anchor" href="#average-counterfactual-adjusted-predictions"></a>
</h3>
<div class="section level4">
<h4 id="stata-3">Stata<a class="anchor" aria-label="anchor" href="#stata-3"></a>
</h4>
<p>Just like Stata’s <code>margins</code> command computes average counterfactual marginal effects, it can also estimate <em>average counterfactual adjusted predictions</em>.</p>
<p>Here is an example:</p>
<pre><code>quietly reg mpg i.cyl##c.hp wt
margins, at(cyl = (4 6 8))

Predictive margins                              Number of obs     =         32
Model VCE    : OLS

Expression   : Linear prediction, predict()

1._at        : cyl             =           4

2._at        : cyl             =           6

3._at        : cyl             =           8

------------------------------------------------------------------------------
             |            Delta-method
             |     Margin   Std. Err.      t    P&gt;|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         _at |
          1  |   17.44233   2.372914     7.35   0.000     12.55522    22.32944
          2  |    18.9149   1.291483    14.65   0.000     16.25505    21.57476
          3  |   18.33318   1.123874    16.31   0.000     16.01852    20.64785
------------------------------------------------------------------------------</code></pre>
<p>Again, this is what Stata does in the background:</p>
<ol style="list-style-type: decimal">
<li>It duplicates the whole dataset 3 times and sets the values of <code>cyl</code> to the three specified values in each of those subsets.</li>
<li>It calculates predictions for that large grid.</li>
<li>It takes the average prediction for each value of <code>cyl</code>.</li>
</ol>
<p>In other words, average counterfactual adjusted predictions as implemented by Stata are a hybrid between predictions at the observed values (the default in <code><a href="../reference/predictions.html">marginaleffects::predictions</a></code>) and predictions at representative values.</p>
</div>
<div class="section level4">
<h4 id="marginaleffects-2">marginaleffects<a class="anchor" aria-label="anchor" href="#marginaleffects-2"></a>
</h4>
<p>You can estimate average counterfactual adjusted predictions with <code><a href="../reference/predictions.html">predictions()</a></code> by, first, setting the <code>grid_type</code> argument of <code><a href="../reference/datagrid.html">datagrid()</a></code> to <code>"counterfactual"</code> and, second, by averaging the predictions using the <code>by</code> argument of <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, or a manual function like <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">dplyr::summarise()</a></code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">*</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>

<span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span>
    <span class="va">mod</span>,
    newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>,
                       grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pred</span>, by <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span>
<span class="co">#&gt; Average Adjusted Predictions </span>
<span class="co">#&gt;   cyl Predicted Std. Error z value   Pr(&gt;|z|) CI low CI high</span>
<span class="co">#&gt; 1   4     17.44      2.373   7.351 1.9733e-13  12.79   22.09</span>
<span class="co">#&gt; 2   6     18.91      1.291  14.646 &lt; 2.22e-16  16.38   21.45</span>
<span class="co">#&gt; 3   8     18.33      1.124  16.312 &lt; 2.22e-16  16.13   20.54</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  lm </span>
<span class="co">#&gt; Prediction type:  response</span>

<span class="va">pred</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>AAP <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">predicted</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 2</span></span>
<span class="co">#&gt;   cyl     AAP</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 4      17.4</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 6      18.9</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 8      18.3</span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="brmsmargins">
<code>brmsmargins</code><a class="anchor" aria-label="anchor" href="#brmsmargins"></a>
</h2>
<p><a href="https://joshuawiley.com/brmsmargins/" class="external-link">The <code>brmsmargins</code> package</a> is developed by Joshua Wiley:</p>
<blockquote>
<p>This package has functions to calculate marginal effects from brms models ( <a href="http://paul-buerkner.github.io/brms/" class="external-link uri">http://paul-buerkner.github.io/brms/</a> ). A central motivator is to calculate average marginal effects (AMEs) for continuous and discrete predictors in fixed effects only and mixed effects regression models including location scale models.</p>
</blockquote>
<p>The two main advantages of <code>brmsmargins</code> over <code>marginaleffects</code> are:</p>
<ol style="list-style-type: decimal">
<li>Ability to compute “Marginal Coefficients” following the method described in <a href="https://doi.org/10.1111/biom.12707" class="external-link">Hedeker et al (2012).</a>
</li>
<li>Ability to <a href="https://joshuawiley.com/brmsmargins/articles/mixed-effects-marginaleffects.html" class="external-link">“integrate out random effects.”</a>
</li>
</ol>
<p>The main advantages of <code>marginaleffects</code> over <code>brmsmargins</code> are:</p>
<ol style="list-style-type: decimal">
<li>Support for 60+ model types, rather than just the <code>brms</code> package.</li>
<li>Simpler user interface (subjective).</li>
<li>At the time of writing (2022-05-25) <code>brmsmargins</code> did not support certain <code>brms</code> models such as those with multivariate or multinomial outcomes. It also did not support custom outcome transformations.</li>
</ol>
<p>The rest of this section presents side-by-side replications of some of the analyses from the <code>brmsmargins</code> vignettes in order to show highlight parallels and differences in syntax.</p>
<div class="section level3">
<h3 id="marginal-effects-for-fixed-effects-models">Marginal Effects for Fixed Effects Models<a class="anchor" aria-label="anchor" href="#marginal-effects-for-fixed-effects-models"></a>
</h3>
<div class="section level4">
<h4 id="ames-for-logistic-regression">AMEs for Logistic Regression<a class="anchor" aria-label="anchor" href="#ames-for-logistic-regression"></a>
</h4>
<p>Estimate a logistic regression model with <code>brms</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://joshuawiley.com/brmsmargins/" class="external-link">brmsmargins</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">marginaleffects</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://withr.r-lib.org" class="external-link">withr</a></span><span class="op">)</span>
<span class="va">h</span> <span class="op">&lt;-</span> <span class="fl">1e-4</span>

<span class="va">void</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span>
    <span class="va">bayes.logistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html" class="external-link">brm</a></span><span class="op">(</span>
      <span class="va">vs</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="va">mpg</span>, data <span class="op">=</span> <span class="va">mtcars</span>,
      family <span class="op">=</span> <span class="st">"bernoulli"</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
      silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,
      chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Compute AMEs manually:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d1</span> <span class="op">&lt;-</span> <span class="va">d2</span> <span class="op">&lt;-</span> <span class="va">mtcars</span>
<span class="va">d2</span><span class="op">$</span><span class="va">mpg</span> <span class="op">&lt;-</span> <span class="va">d2</span><span class="op">$</span><span class="va">mpg</span> <span class="op">+</span> <span class="va">h</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/posterior_epred.brmsfit.html" class="external-link">posterior_epred</a></span><span class="op">(</span><span class="va">bayes.logistic</span>, newdata <span class="op">=</span> <span class="va">d1</span><span class="op">)</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/posterior_epred.brmsfit.html" class="external-link">posterior_epred</a></span><span class="op">(</span><span class="va">bayes.logistic</span>, newdata <span class="op">=</span> <span class="va">d2</span><span class="op">)</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">p2</span> <span class="op">-</span> <span class="va">p1</span><span class="op">)</span> <span class="op">/</span> <span class="va">h</span>
<span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fl">.025</span>, <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;        50%       2.5%      97.5% </span>
<span class="co">#&gt; 0.07014014 0.05437810 0.09159280</span></code></pre></div>
<p>Compute AMEs with <code>brmsmargins</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">bayes.logistic</span>,
  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span> <span class="op">+</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME MPG"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  CI <span class="op">=</span> <span class="fl">0.95</span>,
  CIType <span class="op">=</span> <span class="st">"ETI"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;            M        Mdn        LL        UL PercentROPE PercentMID   CI CIType</span>
<span class="co">#&gt; 1 0.07118446 0.07014014 0.0543781 0.0915928          NA         NA 0.95    ETI</span>
<span class="co">#&gt;   ROPE  MID   Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; &lt;NA&gt; AME MPG</span></code></pre></div>
<p>Compute AMEs using <code>marginaleffects</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">bayes.logistic</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term   Effect    2.5 %   97.5 %</span>
<span class="co">#&gt; 1   am -0.30976 -0.52182 -0.07808</span>
<span class="co">#&gt; 2  mpg  0.07119  0.05439  0.09158</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
<p>The <code>mpg</code> element of the <code>Effect</code> column from <code>marginaleffects</code> matches the the <code>M</code> column of the output from <code>brmsmargins</code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="marginal-effects-for-mixed-effects-models">Marginal Effects for Mixed Effects Models<a class="anchor" aria-label="anchor" href="#marginal-effects-for-mixed-effects-models"></a>
</h3>
<p>Estimate a mixed effects logistic regression model with <code>brms</code>:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span>
  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span>
    <span class="va">nGroups</span> <span class="op">&lt;-</span> <span class="fl">100</span>
    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">20</span>
    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nGroups</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nGroups</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>
    <span class="va">theta.location</span> <span class="op">&lt;-</span> <span class="va">theta.location</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/chol.html" class="external-link">chol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="op">-</span><span class="fl">.25</span>, <span class="fl">.5</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2.5</span>
    <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">theta.location</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span>
    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nObs</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">nGroups</span><span class="op">)</span><span class="op">)</span>
    <span class="va">d</span><span class="op">[</span>, <span class="va">ID</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">nObs</span><span class="op">)</span><span class="op">]</span>

    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">nGroups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">d</span><span class="op">[</span><span class="va">ID</span> <span class="op">==</span> <span class="va">i</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span>
        n <span class="op">=</span> <span class="va">nObs</span>,
        size <span class="op">=</span> <span class="fl">1</span>,
        prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta.location</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span>
        <span class="op">]</span>
    <span class="op">}</span>
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="va">void</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span>
    <span class="va">mlogit</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html" class="external-link">brm</a></span><span class="op">(</span>
      <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">|</span> <span class="va">ID</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"bernoulli"</span>,
      data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
      silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,
      chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Warning: There were 61 divergent transitions after warmup. See</span>
<span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span>
<span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span>
<span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span>
<span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span>
<span class="co">#&gt; Running the chains for more iterations may help. See</span>
<span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span>
<span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span>
<span class="co">#&gt; Running the chains for more iterations may help. See</span>
<span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></code></pre></div>
<div class="section level4">
<h4 id="ame-including-random-effects">AME: Including Random Effects<a class="anchor" aria-label="anchor" href="#ame-including-random-effects"></a>
</h4>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">mlogit</span>,
  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  effects <span class="op">=</span> <span class="st">"includeRE"</span>,
  CI <span class="op">=</span> <span class="fl">.95</span>,
  CIType <span class="op">=</span> <span class="st">"ETI"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;           M       Mdn         LL        UL PercentROPE PercentMID   CI CIType</span>
<span class="co">#&gt; 1 0.1113512 0.1114643 0.08037199 0.1419889          NA         NA 0.95    ETI</span>
<span class="co">#&gt;   ROPE  MID Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; &lt;NA&gt; AME x</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mlogit</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term Effect   2.5 % 97.5 %</span>
<span class="co">#&gt; 1    x 0.1114 0.08037  0.142</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="ame-fixed-effects-only-grand-mean">AME: Fixed Effects Only (Grand Mean)<a class="anchor" aria-label="anchor" href="#ame-fixed-effects-only-grand-mean"></a>
</h4>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">mlogit</span>,
  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  effects <span class="op">=</span> <span class="st">"fixedonly"</span>,
  CI <span class="op">=</span> <span class="fl">.95</span>,
  CIType <span class="op">=</span> <span class="st">"ETI"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;           M       Mdn         LL        UL PercentROPE PercentMID   CI CIType</span>
<span class="co">#&gt; 1 0.1038071 0.1032705 0.06328158 0.1485747          NA         NA 0.95    ETI</span>
<span class="co">#&gt;   ROPE  MID Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; &lt;NA&gt; AME x</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">mlogit</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term Effect   2.5 % 97.5 %</span>
<span class="co">#&gt; 1    x 0.1038 0.06328 0.1486</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="marginal-effects-for-location-scale-models">Marginal Effects for Location Scale Models<a class="anchor" aria-label="anchor" href="#marginal-effects-for-location-scale-models"></a>
</h3>
<div class="section level4">
<h4 id="ames-for-fixed-effects-location-scale-models">AMEs for Fixed Effects Location Scale Models<a class="anchor" aria-label="anchor" href="#ames-for-fixed-effects-location-scale-models"></a>
</h4>
<p>Estimate a fixed effects location scale model with <code>brms</code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span>
  seed <span class="op">=</span> <span class="fl">12345</span>, code <span class="op">=</span> <span class="op">{</span>
    <span class="va">nObs</span> <span class="op">&lt;-</span> <span class="fl">1000L</span>
    <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>
      grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, each <span class="op">=</span> <span class="va">nObs</span> <span class="op">/</span> <span class="fl">2L</span><span class="op">)</span>,
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nObs</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>
    <span class="va">d</span><span class="op">[</span>, <span class="va">y</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">nObs</span>,
                   mean <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="va">grp</span>,
                   sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">grp</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
    <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="va">void</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span>
    <span class="va">ls.fe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html" class="external-link">brm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>
      <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">grp</span>,
      <span class="va">sigma</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x</span> <span class="op">+</span> <span class="va">grp</span><span class="op">)</span>,
      family <span class="op">=</span> <span class="st">"gaussian"</span>,
      data <span class="op">=</span> <span class="va">d</span>, seed <span class="op">=</span> <span class="fl">1234</span>,
      silent <span class="op">=</span> <span class="fl">2</span>, refresh <span class="op">=</span> <span class="fl">0</span>,
      chains <span class="op">=</span> <span class="fl">4L</span>, cores <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="fixed-effects-only">Fixed effects only<a class="anchor" aria-label="anchor" href="#fixed-effects-only"></a>
</h4>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">ls.fe</span>,
  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  CI <span class="op">=</span> <span class="fl">0.95</span>, CIType <span class="op">=</span> <span class="st">"ETI"</span>,
  effects <span class="op">=</span> <span class="st">"fixedonly"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;          M     Mdn        LL       UL PercentROPE PercentMID   CI CIType ROPE</span>
<span class="co">#&gt; 1 1.625042 1.63264 0.7558805 2.497346          NA         NA 0.95    ETI &lt;NA&gt;</span>
<span class="co">#&gt;    MID Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; AME x</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">ls.fe</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term Effect  2.5 % 97.5 %</span>
<span class="co">#&gt; 1    x  1.625 0.7559  2.497</span>
<span class="co">#&gt; 2  grp  1.011 0.3482  1.678</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="discrete-change-and-distributional-parameter-dpar">Discrete change and distributional parameter (<code>dpar</code>)<a class="anchor" aria-label="anchor" href="#discrete-change-and-distributional-parameter-dpar"></a>
</h4>
<p>Compute the contrast between adjusted predictions on the <code>sigma</code> parameter, when <code>grp=0</code> and <code>grp=1</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">ls.fe</span>,
  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME grp"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,
  CI <span class="op">=</span> <span class="fl">0.95</span>, CIType <span class="op">=</span> <span class="st">"ETI"</span>, dpar <span class="op">=</span> <span class="st">"sigma"</span>,
  effects <span class="op">=</span> <span class="st">"fixedonly"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;          M      Mdn       LL       UL PercentROPE PercentMID   CI CIType ROPE</span>
<span class="co">#&gt; 1 4.901384 4.895236 4.404996 5.417512          NA         NA 0.95    ETI &lt;NA&gt;</span>
<span class="co">#&gt;    MID   Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; AME grp</span></code></pre></div>
<p>In <code>marginaleffects</code> we use the <code><a href="../reference/comparisons.html">comparisons()</a></code> function and the <code>variables</code> argument:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span>
  <span class="va">ls.fe</span>,
  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>grp <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,
  dpar <span class="op">=</span> <span class="st">"sigma"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span>
<span class="co">#&gt; Average contrasts </span>
<span class="co">#&gt;   Term Contrast Effect 2.5 % 97.5 %</span>
<span class="co">#&gt; 1  grp    1 - 0  4.901 4.405  5.418</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="marginal-effect-continuous-on-sigma">Marginal effect (continuous) on sigma<a class="anchor" aria-label="anchor" href="#marginal-effect-continuous-on-sigma"></a>
</h4>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://joshuawiley.com/brmsmargins/reference/brmsmargins.html" class="external-link">brmsmargins</a></span><span class="op">(</span>
  <span class="va">ls.fe</span>,
  add <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  contrasts <span class="op">=</span> <span class="fu"><a href="https://amices.org/mice/reference/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"AME x"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="va">h</span>, <span class="fl">1</span> <span class="op">/</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span>,
  CI <span class="op">=</span> <span class="fl">0.95</span>, CIType <span class="op">=</span> <span class="st">"ETI"</span>, dpar <span class="op">=</span> <span class="st">"sigma"</span>,
  effects <span class="op">=</span> <span class="st">"fixedonly"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">bm</span><span class="op">$</span><span class="va">ContrastSummary</span><span class="op">)</span>
<span class="co">#&gt;          M      Mdn       LL       UL PercentROPE PercentMID   CI CIType ROPE</span>
<span class="co">#&gt; 1 4.455297 4.443977 3.500513 5.449401          NA         NA 0.95    ETI &lt;NA&gt;</span>
<span class="co">#&gt;    MID Label</span>
<span class="co">#&gt; 1 &lt;NA&gt; AME x</span>

<span class="va">mfx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/marginaleffects.html">marginaleffects</a></span><span class="op">(</span><span class="va">ls.fe</span>, dpar <span class="op">=</span> <span class="st">"sigma"</span>, re_formula <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mfx</span><span class="op">)</span>
<span class="co">#&gt; Average marginal effects </span>
<span class="co">#&gt;   Term Effect 2.5 % 97.5 %</span>
<span class="co">#&gt; 1    x  4.455 3.501  5.450</span>
<span class="co">#&gt; 2  grp  5.293 4.694  5.926</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Model type:  brmsfit </span>
<span class="co">#&gt; Prediction type:  response</span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="effects">
<code>effects</code><a class="anchor" aria-label="anchor" href="#effects"></a>
</h2>
<p>The <a href="https://cran.r-project.org/eb/packages/effects/index.html" class="external-link"><code>effects</code> package</a> was created by John Fox and colleagues.</p>
<ul>
<li>
<code>marginaleffects</code> supports 30+ more model types than <code>effects</code>.</li>
<li>
<code>effects</code> focuses on the computation of <a href="https://vincentarelbundock.github.io/marginaleffects/articles/mfx01_predictions.html" class="external-link">“adjusted predictions.”</a> The plots it produces are roughly equivalent to the ones produced by the <code>plot_cap</code> and <code>predictions</code> functions in <code>marginaleffects</code>.</li>
<li>
<code>effects</code> does not appear support marginal effects (slopes), marginal means, or contrasts</li>
<li>
<code>effects</code> uses Base graphics whereas <code>marginaleffects</code> uses <code>ggplot2</code>
</li>
<li>
<code>effects</code> includes <em>a lot</em> of very powerful options to customize plots. In contrast, <code>marginaleffects</code> produces objects which can be customized by chaining <code>ggplot2</code> functions. Users can also call <code>plot_cap(model, draw=FALSE)</code> to create a prediction grid, and then work the raw data directly to create the plot they need</li>
</ul>
<p><code>effects</code> offers several options which are not currently available in <code>marginaleffects</code>, including:</p>
<ul>
<li>Partial residuals plots</li>
<li>Many types of ways to plot adjusted predictions: <a href="https://cran.r-project.org/web/packages/effects/vignettes/predictor-effects-gallery.pdf" class="external-link">package vignette</a>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="modelbased">
<code>modelbased</code><a class="anchor" aria-label="anchor" href="#modelbased"></a>
</h2>
<p>The <a href="https://easystats.github.io/modelbased/" class="external-link"><code>modelbased</code> package</a> is developed by the <code>easystats</code> team.</p>
<p>This section is incomplete; contributions are welcome.</p>
<ul>
<li>Wrapper around <code>emmeans</code> to compute marginal means and marginal effects.</li>
<li>Powerful functions to create beautiful plots.</li>
</ul>
</div>
<div class="section level2">
<h2 id="ggeffects">
<code>ggeffects</code><a class="anchor" aria-label="anchor" href="#ggeffects"></a>
</h2>
<p>The <a href="https://strengejacke.github.io/ggeffects/" class="external-link"><code>ggeffects</code></a> package is developed by Daniel Lüdecke.</p>
<p>This section is incomplete; contributions are welcome.</p>
<ul>
<li>Wrapper around <code>emmeans</code> to compute marginal means.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
